# =============================================================
# sysctl — VPN нода (VLESS TCP REALITY XTLS Vision + self-steal)
# Xray-core, 443 порт, много долгоживущих TCP соединений
# =============================================================

### Форвардинг — обязательно для VPN и Docker
net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
net.ipv6.conf.all.forwarding = 1

### Защита от спуфинга и редиректов
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
# strict (1) может дропать пакеты при асимметричной маршрутизации VPN
# loose (2) — проверяет только существование маршрута, безопасно для VPN
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

# Логирование подозрительных пакетов
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

### ICMP
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ratelimit = 100
net.ipv4.icmp_ratemask = 88089
net.ipv4.icmp_ignore_bogus_error_responses = 1

### TCP — защита
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_fin_timeout = 20
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_max_tw_buckets = 262144

# ECN = 2 (только по запросу клиента) — безопаснее для REALITY
# чтобы не влиять на TLS handshake паттерны
net.ipv4.tcp_ecn = 2
net.ipv4.tcp_sack = 1

### Keepalive — XTLS Vision держит соединения долго
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 60
net.ipv4.tcp_keepalive_probes = 5

### Буферы TCP — увеличены под большой трафик клиентов
# Vision гоняет много данных в одном соединении
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864

### Очереди ядра — под большое число соединений
# Xray многопоточный, большая очередь важна
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 50000

### Порты для NAT клиентского трафика
net.ipv4.ip_local_port_range = 1024 65535

### Conntrack — таблица соединений при NAT
# На 443 порту сотни клиентов различаются только по IP
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_timeout_established = 3600
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30

### BBR — критично для снижения латенции в XTLS Vision
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

### Безопасность ядра
kernel.yama.ptrace_scope = 1
kernel.randomize_va_space = 2
fs.suid_dumpable = 0

### Файловая система и память
# Xray открывает много дескрипторов при сотнях клиентов
fs.file-max = 2097152
vm.swappiness = 10
